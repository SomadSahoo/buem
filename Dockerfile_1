FROM continuumio/miniconda3

# create a working directory and copy into it
WORKDIR /app

# Copy only environment first to leverage Docker cache when deps don't change
COPY environment.yml /app/

# Create conda environment (name expected in environment.yml, e.g. buem_env)
RUN conda env create -f environment.yml && conda clean -afy

# Ensure gunicorn available if not present in environment.yml
RUN /opt/conda/envs/buem_env/bin/pip install --no-cache-dir gunicorn || true

# Copy project files after environment is created (cache friendly)
COPY . /app

# Copy and make entrypoint executable
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Set PYTHONPATH for module imports
ENV PYTHONPATH=/app/src

# Expose port (documentary; mapping controlled by compose)
EXPOSE 5000

# Use the entrypoint script as runtime switch
ENTRYPOINT ["/app/entrypoint.sh"]
# Default command delegates to entrypoint (which defaults RUN_MODE=worker)
CMD ["bash", "-c", ""] 