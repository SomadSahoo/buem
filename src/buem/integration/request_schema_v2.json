{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://buem.energy/schemas/request/v2",
  "title": "BUEM GeoJSON Request Schema v2",
  "description": "Schema for BUEM building energy model requests supporting hybrid component structure",
  "type": "object",
  "required": ["type", "features"],
  "properties": {
    "type": { 
      "const": "FeatureCollection",
      "description": "GeoJSON type identifier"
    },
    "timeStamp": { 
      "type": "string", 
      "format": "date-time",
      "description": "Request timestamp"
    },
    "numberMatched": { 
      "type": "number",
      "description": "Total number of features matched"
    },
    "numberReturned": { 
      "type": "number",
      "description": "Number of features returned"
    },
    "features": {
      "type": "array",
      "items": { "$ref": "#/$defs/feature" },
      "minItems": 1,
      "description": "Array of building features to process"
    }
  },

  "$defs": {
    "feature": {
      "type": "object",
      "required": ["type", "id", "geometry", "properties"],
      "properties": {
        "type": { 
          "const": "Feature",
          "description": "GeoJSON feature type"
        },
        "id": { 
          "type": "string",
          "description": "Unique building identifier"
        },
        "geometry": { "$ref": "#/$defs/geometry" },
        "properties": { "$ref": "#/$defs/properties" }
      }
    },

    "geometry": {
      "type": "object",
      "required": ["type", "coordinates"],
      "properties": {
        "type": { 
          "const": "Point",
          "description": "Geometry type - only Point supported"
        },
        "coordinates": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 2,
          "maxItems": 3,
          "description": "Geographic coordinates [longitude, latitude, elevation?]"
        }
      }
    },

    "properties": {
      "type": "object",
      "required": ["start_time", "end_time", "buem"],
      "properties": {
        "start_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Simulation start time"
        },
        "end_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Simulation end time"
        },
        "resolution": { 
          "type": "string",
          "default": "60",
          "description": "Time resolution value"
        },
        "resolution_unit": { 
          "type": "string",
          "default": "minutes",
          "description": "Time resolution unit"
        },
        "buem": { "$ref": "#/$defs/buem" }
      }
    },

    "buem": {
      "type": "object",
      "required": ["building_attributes"],
      "properties": {
        "building_attributes": { "$ref": "#/$defs/building_attributes" },
        "child_components": {
          "type": "array",
          "items": { "$ref": "#/$defs/child_component" },
          "description": "Alternative flat component format (converted to nested)"
        },
        "use_milp": {
          "type": "boolean",
          "default": false,
          "description": "Use Mixed Integer Linear Programming solver"
        }
      }
    },

    "building_attributes": {
      "type": "object",
      "required": ["latitude", "longitude"],
      "properties": {
        "latitude": { 
          "type": "number", 
          "minimum": -90, 
          "maximum": 90,
          "description": "Geographic latitude in degrees"
        },
        "longitude": { 
          "type": "number", 
          "minimum": -180, 
          "maximum": 180,
          "description": "Geographic longitude in degrees"
        },
        "A_ref": { 
          "type": "number", 
          "minimum": 0,
          "description": "Reference floor area in m²"
        },
        "h_room": { 
          "type": "number", 
          "minimum": 0,
          "description": "Average room height in m"
        },
        "components": { "$ref": "#/$defs/components" },
        
        "_external_format_fields": {
          "description": "Fields from external schemas for compatibility",
          "country": { "type": "string" },
          "building_type": { "type": "string" },
          "construction_period": { "type": "string" },
          "heated_area_m2": { "type": "number", "minimum": 0 },
          "volume_m3": { "type": "number", "minimum": 0 },
          "height_m": { "type": "number", "minimum": 0 }
        }
      }
    },

    "components": {
      "type": "object",
      "description": "Nested building component structure (preferred format)",
      "properties": {
        "Walls": { "$ref": "#/$defs/component" },
        "Roof": { "$ref": "#/$defs/component" },
        "Floor": { "$ref": "#/$defs/component" },
        "Windows": { "$ref": "#/$defs/window_component" },
        "Doors": { "$ref": "#/$defs/component" },
        "Ventilation": { "$ref": "#/$defs/ventilation_component" }
      },
      "additionalProperties": { "$ref": "#/$defs/component" }
    },

    "component": {
      "type": "object",
      "required": ["elements"],
      "properties": {
        "U": { 
          "type": "number", 
          "minimum": 0,
          "description": "Component-level thermal transmittance (W/m²K)"
        },
        "b_transmission": { 
          "type": "number", 
          "minimum": 0,
          "default": 1.0,
          "description": "Transmission correction factor"
        },
        "elements": {
          "type": "array",
          "items": { "$ref": "#/$defs/component_element" },
          "minItems": 1,
          "description": "Array of individual component elements"
        }
      }
    },

    "window_component": {
      "type": "object",
      "required": ["elements"],
      "properties": {
        "U": { 
          "type": "number", 
          "minimum": 0,
          "description": "Window thermal transmittance (W/m²K)"
        },
        "g_gl": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 1,
          "default": 0.5,
          "description": "Solar heat gain coefficient"
        },
        "elements": {
          "type": "array",
          "items": { "$ref": "#/$defs/window_element" },
          "minItems": 1
        }
      }
    },

    "ventilation_component": {
      "type": "object",
      "required": ["elements"],
      "properties": {
        "elements": {
          "type": "array",
          "items": { "$ref": "#/$defs/ventilation_element" },
          "minItems": 1
        }
      }
    },

    "component_element": {
      "type": "object",
      "required": ["id", "area", "azimuth", "tilt"],
      "properties": {
        "id": { 
          "type": "string",
          "minLength": 1,
          "description": "Unique element identifier"
        },
        "area": { 
          "type": "number", 
          "minimum": 0,
          "description": "Element area in m²"
        },
        "azimuth": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 360,
          "description": "Element orientation in degrees (0=North, 90=East)"
        },
        "tilt": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 90,
          "description": "Element tilt in degrees (0=horizontal, 90=vertical)"
        },
        "U": { 
          "type": "number", 
          "minimum": 0,
          "description": "Element-specific thermal transmittance (overrides component U)"
        }
      }
    },

    "window_element": {
      "allOf": [
        { "$ref": "#/$defs/component_element" },
        {
          "properties": {
            "surface": { 
              "type": "string",
              "description": "ID of surface this window is attached to"
            }
          }
        }
      ]
    },

    "ventilation_element": {
      "type": "object",
      "required": ["id", "air_changes"],
      "properties": {
        "id": { 
          "type": "string",
          "minLength": 1,
          "description": "Ventilation system identifier"
        },
        "air_changes": { 
          "type": "number", 
          "minimum": 0,
          "description": "Air changes per hour"
        }
      }
    },

    "child_component": {
      "type": "object",
      "required": [
        "component_id",
        "component_type",
        "area_m2",
        "orientation_deg",
        "tilt_deg"
      ],
      "properties": {
        "component_id": { 
          "type": "string",
          "description": "Component identifier"
        },
        "component_type": { 
          "type": "string",
          "enum": ["wall", "roof", "floor", "window", "door", "ventilation"],
          "description": "Type of building component"
        },
        "area_m2": { 
          "type": "number", 
          "minimum": 0,
          "description": "Component area in m²"
        },
        "orientation_deg": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 360,
          "description": "Component orientation in degrees"
        },
        "tilt_deg": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 90,
          "description": "Component tilt in degrees"
        },
        "u_value": { 
          "type": "number", 
          "minimum": 0,
          "description": "Thermal transmittance (W/m²K)"
        },
        "surface_reference": { 
          "type": "string",
          "description": "Reference to parent surface (for windows/doors)"
        }
      }
    }
  }
}