{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://buem.energy/schemas/response/v2",
  "title": "BUEM GeoJSON Response Schema v2", 
  "description": "Schema for BUEM building energy model responses with thermal load profiles",
  "type": "object",
  "required": ["type", "features"],
  "properties": {
    "type": { 
      "const": "FeatureCollection",
      "description": "GeoJSON type identifier"
    },
    "timeStamp": { 
      "type": "string", 
      "format": "date-time",
      "description": "Response timestamp"
    },
    "processed_at": { 
      "type": "string", 
      "format": "date-time",
      "description": "Processing completion timestamp"
    },
    "processing_elapsed_s": { 
      "type": "number",
      "description": "Total processing time in seconds"
    },
    "numberMatched": { 
      "type": "number",
      "description": "Total number of features processed"
    },
    "numberReturned": { 
      "type": "number",
      "description": "Number of features returned"
    },
    "features": {
      "type": "array",
      "items": { "$ref": "#/$defs/feature" },
      "description": "Array of processed building features with results"
    }
  },

  "$defs": {
    "feature": {
      "type": "object",
      "required": ["type", "id", "geometry", "properties"],
      "properties": {
        "type": { 
          "const": "Feature",
          "description": "GeoJSON feature type"
        },
        "id": { 
          "type": "string",
          "description": "Building identifier" 
        },
        "geometry": { "$ref": "#/$defs/geometry" },
        "properties": { "$ref": "#/$defs/properties" }
      }
    },

    "geometry": {
      "type": "object",
      "required": ["type", "coordinates"],
      "properties": {
        "type": { 
          "const": "Point",
          "description": "Geometry type"
        },
        "coordinates": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 2,
          "maxItems": 3,
          "description": "Geographic coordinates [longitude, latitude, elevation?]"
        }
      }
    },

    "properties": {
      "type": "object", 
      "required": [
        "start_time", 
        "end_time", 
        "resolution",
        "resolution_unit", 
        "buem"
      ],
      "properties": {
        "start_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Simulation start time"
        },
        "end_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Simulation end time" 
        },
        "resolution": { 
          "type": "string",
          "description": "Time resolution value"
        },
        "resolution_unit": { 
          "type": "string",
          "description": "Time resolution unit"
        },
        "buem": { "$ref": "#/$defs/buem" }
      }
    },

    "buem": {
      "type": "object",
      "required": [
        "building_attributes",
        "thermal_load_profile"
      ],
      "properties": {
        "building_attributes": {
          "type": "object",
          "description": "Original building attributes from request (echoed back)"
        },
        "child_components": {
          "type": "array", 
          "items": { "$ref": "#/$defs/child_component_response" },
          "description": "Component information for external compatibility"
        },
        "thermal_load_profile": { "$ref": "#/$defs/thermal_load_profile" },
        "model_metadata": { "$ref": "#/$defs/model_metadata" }
      }
    },

    "thermal_load_profile": {
      "type": "object",
      "required": [
        "start_time",
        "end_time", 
        "resolution",
        "resolution_unit",
        "summary"
      ],
      "properties": {
        "start_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Profile start time"
        },
        "end_time": { 
          "type": "string", 
          "format": "date-time",
          "description": "Profile end time"
        },
        "resolution": { 
          "type": "string",
          "description": "Time resolution"
        },
        "resolution_unit": { 
          "type": "string", 
          "description": "Resolution unit"
        },
        "summary": { "$ref": "#/$defs/load_summary" },
        "timeseries": { "$ref": "#/$defs/load_timeseries" },
        "timeseries_file": { 
          "type": "string",
          "description": "Path to detailed timeseries file (if saved)"
        }
      }
    },

    "load_summary": {
      "type": "object",
      "required": ["heating", "cooling", "electricity"],
      "properties": {
        "heating": { "$ref": "#/$defs/energy_summary" },
        "cooling": { "$ref": "#/$defs/energy_summary" },
        "electricity": { "$ref": "#/$defs/energy_summary" },
        "total_energy_demand_kwh": { 
          "type": "number",
          "description": "Total annual energy demand"
        },
        "peak_heating_load_kw": { 
          "type": "number",
          "description": "Peak heating load"
        },
        "peak_cooling_load_kw": { 
          "type": "number",
          "description": "Peak cooling load"
        },
        "energy_intensity_kwh_m2": { 
          "type": "number",
          "description": "Energy intensity per floor area"
        }
      }
    },

    "energy_summary": {
      "type": "object",
      "required": ["total_kwh", "max_kw", "min_kw", "mean_kw"],
      "properties": {
        "total_kwh": { 
          "type": "number",
          "description": "Total energy consumption in kWh"
        },
        "max_kw": { 
          "type": "number",
          "description": "Maximum power demand in kW"
        },
        "min_kw": { 
          "type": "number",
          "description": "Minimum power demand in kW" 
        },
        "mean_kw": { 
          "type": "number",
          "description": "Average power demand in kW"
        },
        "median_kw": { 
          "type": "number",
          "description": "Median power demand in kW"
        },
        "std_kw": { 
          "type": "number",
          "description": "Standard deviation of power demand"
        }
      }
    },

    "load_timeseries": {
      "type": "object",
      "description": "Hourly timeseries data (optional, only if requested)",
      "properties": {
        "timestamps": {
          "type": "array",
          "items": { "type": "string", "format": "date-time" },
          "description": "Array of timestamps"
        },
        "heating_kw": {
          "type": "array",
          "items": { "type": "number" },
          "description": "Hourly heating loads in kW"
        },
        "cooling_kw": {
          "type": "array", 
          "items": { "type": "number" },
          "description": "Hourly cooling loads in kW"
        },
        "electricity_kw": {
          "type": "array",
          "items": { "type": "number" },
          "description": "Hourly electricity consumption in kW"
        }
      }
    },

    "model_metadata": {
      "type": "object",
      "properties": {
        "model_version": { 
          "type": "string",
          "description": "BUEM model version"
        },
        "solver_used": { 
          "type": "string",
          "description": "Optimization solver used"
        },
        "processing_time_s": { 
          "type": "number",
          "description": "Feature processing time in seconds"
        },
        "weather_year": { 
          "type": "integer",
          "description": "Weather data year used"
        },
        "validation_warnings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Any validation warnings encountered"
        }
      }
    },

    "child_component_response": {
      "allOf": [
        {
          "type": "object",
          "required": [
            "component_id",
            "component_type", 
            "area_m2",
            "orientation_deg",
            "tilt_deg"
          ],
          "properties": {
            "component_id": { 
              "type": "string",
              "description": "Component identifier"
            },
            "component_type": { 
              "type": "string",
              "description": "Component type"
            },
            "area_m2": { 
              "type": "number",
              "description": "Component area in mÂ²"
            },
            "orientation_deg": { 
              "type": "number",
              "description": "Component orientation in degrees"
            },
            "tilt_deg": { 
              "type": "number", 
              "description": "Component tilt in degrees"
            },
            "u_value_used": { 
              "type": "number",
              "description": "Actual U-value used in simulation"
            }
          }
        }
      ]
    }
  }
}